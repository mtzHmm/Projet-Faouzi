<div class="admin-layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Provider Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a [routerLink]="['/provider']" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a [routerLink]="['/provider/products']" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üì¶</span>
        <span class="nav-text">Products</span>
      </a>
      <a [routerLink]="['/provider/orders']" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìã</span>
        <span class="nav-text">Orders</span>
      </a>
      <a [routerLink]="['/provider/reports']" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìà</span>
        <span class="nav-text">Reports</span>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <h1>üì¶ Product Management</h1>
      <p *ngIf="currentStore">Managing products for: <strong>{{ currentStore.storeName || currentStore.name }}</strong> ({{ storeType | titlecase }})</p>
      <p *ngIf="!currentStore">Manage your products, inventory, and pricing</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading products...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <div class="error-icon">‚ùå</div>
      <h3>Failed to Load Products</h3>
      <p>{{ error }}</p>
      <button (click)="loadProducts()" class="retry-btn">üîÑ Retry</button>
    </div>

    <!-- Filters and Controls -->
    <div class="controls-section">
      <div class="search-filters">
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="filterProducts()"
          placeholder="Search products..." 
          class="search-input">
        
        <select 
          [(ngModel)]="selectedCategory" 
          (change)="filterProducts()" 
          class="filter-select">
          <option value="">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.name">{{ category.name }}</option>
        </select>

        <select 
          [(ngModel)]="selectedStatus" 
          (change)="filterProducts()" 
          class="filter-select">
          <option value="">All Status</option>
          <option *ngFor="let status of statuses" [value]="status">{{ status | titlecase }}</option>
        </select>
      </div>

      <button (click)="addProduct()" class="add-btn">
        ‚ûï Add Product
      </button>
    </div>

    <!-- Products Grid -->
    <div *ngIf="!loading && !error" class="products-grid">
      <div *ngFor="let product of filteredProducts" class="product-card">
        <div class="product-header-with-status">
          <div class="status-badge" [class]="getProductStatus(product)">{{ getProductStatus(product) }}</div>
        </div>

        <!-- Product Image -->
        <div class="product-image-container">
          <img 
            *ngIf="product.image && product.image.trim() !== ''" 
            [src]="product.image" 
            [alt]="product.name"
            class="product-image"
            (error)="onImageError($event)"
            (load)="onImageLoad($event, product)">
          <div *ngIf="!product.image || product.image.trim() === ''" class="product-image-placeholder">
            <div class="image-placeholder-icon">üì¶</div>
            <span>No Image</span>
          </div>
        </div>
        
        <div class="product-info">
          <div class="product-header">
            <h3>{{ product.name }}</h3>
            <span class="product-id">#{{ product.id }}</span>
          </div>
          
          <p class="product-description">{{ product.description }}</p>
          
          <div class="product-details">
            <div class="detail-item">
              <span class="label">Category:</span>
              <span class="value">{{ getProductCategory(product) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Price:</span>
              <span class="value price">{{ product.price | number:'1.2-2' }} DT</span>
            </div>
            <div class="detail-item">
              <span class="label">Restaurant:</span>
              <span class="value">{{ product.restaurant }}</span>
            </div>
            <div *ngIf="product.prescription" class="detail-item">
              <span class="label">Prescription:</span>
              <span class="value prescription">Required</span>
            </div>
          </div>

          <div class="product-actions">
            <button (click)="editProduct(product.id)" class="action-btn edit" type="button">
              ‚úèÔ∏è Edit
            </button>
            <button (click)="toggleStatus(product.id)" class="action-btn toggle">
              {{ getProductStatus(product) === 'active' ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable' }}
            </button>
            <button (click)="deleteProduct(product.id)" class="action-btn delete">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && filteredProducts.length === 0" class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h3>No products found</h3>
      <p *ngIf="searchTerm || selectedCategory || selectedStatus">Try adjusting your search criteria</p>
      <p *ngIf="!searchTerm && !selectedCategory && !selectedStatus && currentStore">No products found for {{ currentStore.storeName || currentStore.name }}. Add your first product to get started!</p>
      <button (click)="addProduct()" class="add-btn">‚ûï Add Product</button>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div *ngIf="showAddProductModal" class="modal-overlay" (click)="closeAddProductModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ûï Add New Product</h2>
      <button class="close-btn" (click)="closeAddProductModal()">‚úï</button>
    </div>

    <form (ngSubmit)="onSubmitProduct()" class="add-product-form">
      <div class="form-group">
        <label for="productName">Product Name *</label>
        <input 
          type="text" 
          id="productName"
          [(ngModel)]="newProduct.name"
          name="productName"
          required
          placeholder="Enter product name"
          class="form-input">
      </div>

      <div class="form-group">
        <label for="productDescription">Description *</label>
        <textarea 
          id="productDescription"
          [(ngModel)]="newProduct.description"
          name="productDescription"
          required
          placeholder="Enter product description"
          rows="3"
          class="form-textarea"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="productPrice">Price *</label>
          <input 
            type="number" 
            id="productPrice"
            [(ngModel)]="newProduct.price"
            name="productPrice"
            required
            step="0.01"
            min="0"
            placeholder="0.00"
            class="form-input">
        </div>

        <div class="form-group">
          <label for="productCategory">Category *</label>
          <select 
            id="productCategory"
            [(ngModel)]="newProduct.category_id"
            name="productCategory"
            required
            class="form-select">
            <option value="">Select Category</option>
            <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
          </select>
        </div>
      </div>

      <div *ngIf="storeType === 'pharmacie'" class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="newProduct.prescription"
            name="productPrescription"
            class="checkbox-input">
          <span class="checkbox-text">Requires Prescription</span>
        </label>
      </div>

      <div class="form-group">
        <label for="productImage">Product Image</label>
        <div class="image-upload-area">
          <input 
            type="file" 
            id="productImage"
            #fileInput
            (change)="onFileSelect($event)"
            accept="image/*"
            class="file-input">
          
          <div *ngIf="!imagePreview" class="upload-placeholder" (click)="fileInput.click()">
            <div class="upload-icon">üì∑</div>
            <p>Click to upload image</p>
            <p class="upload-hint">PNG, JPG up to 10MB</p>
          </div>

          <div *ngIf="imagePreview" class="image-preview">
            <img [src]="imagePreview" alt="Preview" class="preview-image">
            <button type="button" class="remove-image-btn" (click)="removeImage()">‚úï</button>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeAddProductModal()" [disabled]="addingProduct">
          Cancel
        </button>
        <button type="submit" class="submit-btn" [disabled]="addingProduct">
          <span *ngIf="!addingProduct">‚ûï Add Product</span>
          <span *ngIf="addingProduct">Adding Product...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Product Modal -->
<div *ngIf="showEditProductModal" class="modal-overlay" (click)="closeEditProductModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Product</h2>
      <button class="close-btn" (click)="closeEditProductModal()">‚úï</button>
    </div>

    <form (ngSubmit)="onSubmitEditProduct()" class="add-product-form">
      <div class="form-group">
        <label for="editProductName">Product Name *</label>
        <input 
          type="text" 
          id="editProductName"
          [(ngModel)]="editProduct_data.name"
          name="editProductName"
          required
          placeholder="Enter product name"
          class="form-input">
      </div>

      <div class="form-group">
        <label for="editProductDescription">Description *</label>
        <textarea 
          id="editProductDescription"
          [(ngModel)]="editProduct_data.description"
          name="editProductDescription"
          required
          placeholder="Enter product description"
          rows="3"
          class="form-textarea"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="editProductPrice">Price *</label>
          <input 
            type="number" 
            id="editProductPrice"
            [(ngModel)]="editProduct_data.price"
            name="editProductPrice"
            required
            step="0.01"
            min="0.01"
            placeholder="0.00"
            class="form-input"
            [value]="editProduct_data.price">
        </div>

        <div class="form-group">
          <label for="editProductCategory">Category *</label>
          <select 
            id="editProductCategory"
            [(ngModel)]="editProduct_data.category_id"
            name="editProductCategory"
            required
            class="form-select">
            <option value="">Select Category</option>
            <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
          </select>
        </div>
      </div>

      <div *ngIf="storeType === 'pharmacie'" class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="editProduct_data.prescription"
            name="editProductPrescription"
            class="checkbox-input">
          <span class="checkbox-text">Requires Prescription</span>
        </label>
      </div>

      <div class="form-group">
        <label for="editProductImage">Product Image</label>
        <div class="image-upload-area">
          <input 
            type="file" 
            id="editProductImage"
            #editFileInput
            (change)="onFileSelect($event)"
            accept="image/*"
            class="file-input">
          
          <div *ngIf="!imagePreview" class="upload-placeholder" (click)="editFileInput.click()">
            <div class="upload-icon">üì∑</div>
            <p>Click to upload new image</p>
            <p class="upload-hint">PNG, JPG up to 10MB</p>
          </div>

          <div *ngIf="imagePreview" class="image-preview">
            <img [src]="imagePreview" alt="Preview" class="preview-image">
            <button type="button" class="remove-image-btn" (click)="removeImage()">‚úï</button>
            <div class="image-status" *ngIf="!selectedFile && editProduct_data.currentImage">
              <small>Current image (no changes)</small>
            </div>
            <div class="image-status" *ngIf="selectedFile">
              <small>New image selected</small>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeEditProductModal()" [disabled]="editingProduct">
          Cancel
        </button>
        <button type="submit" class="submit-btn" [disabled]="editingProduct">
          <span *ngIf="!editingProduct">üíæ Update Product</span>
          <span *ngIf="editingProduct">Updating Product...</span>
        </button>
      </div>
    </form>
  </div>
</div>