<div class="admin-layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a routerLink="/admin" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon">‚ö°</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a routerLink="/admin/orders" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìã</span>
        <span class="nav-text">Orders</span>
      </a>
      <a routerLink="/user-management" routerLinkActive="active" class="nav-item users-nav">
        <span class="nav-icon">üë•</span>
        <span class="nav-text">Users</span>
      </a>
      <a routerLink="/admin/stats" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìä</span>
        <span class="nav-text">Stats</span>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="admin-orders">
      <!-- Header -->
      <div class="page-header">
        <div class="header-content">
          <h1><i class="fas fa-clipboard-list"></i> Gestion des Commandes</h1>
          <p>Suivez et g√©rez toutes les commandes depuis la base de donn√©es</p>
        </div>
        <div class="header-actions">
          <button (click)="loadOrders()" class="refresh-btn">
            <i class="fas fa-sync-alt"></i>
            Actualiser
          </button>
          <a routerLink="/admin" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Retour au tableau de bord
          </a>
        </div>
      </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input 
        type="text" 
        placeholder="Rechercher par nom, email ou ID..."
        [(ngModel)]="searchTerm"
        (input)="filterOrders()">
    </div>
    
    <div class="status-filter">
      <select [(ngModel)]="selectedStatus" (change)="filterOrders()">
        <option value="all">Tous les statuts</option>
        <option *ngFor="let status of statuses" [value]="status">
          {{ getStatusText(status) }}
        </option>
      </select>
    </div>

    <div class="results-count">
      <span>{{ filteredOrders.length }} commande(s) trouv√©e(s)</span>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading orders...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <p>‚ùå {{ error }}</p>
    <button (click)="loadOrders()" class="retry-btn">üîÑ Retry</button>
  </div>

  <!-- Table des commandes -->
  <div *ngIf="!loading && !error" class="orders-container">
    <div class="orders-table">
      <div class="table-header">
        <div class="col-id">ID</div>
        <div class="col-customer">Client</div>
        <div class="col-items">Articles</div>
        <div class="col-total">Total</div>
        <div class="col-status">Statut</div>
        <div class="col-time">Date</div>
        <div class="col-actions">Actions</div>
      </div>
      
      <div class="table-row" *ngFor="let order of filteredOrders; trackBy: trackOrder">
        <div class="col-id">#{{ order.id }}</div>
        
        <div class="col-customer">
          <div class="customer-info">
            <strong>{{ order.userName || 'N/A' }}</strong>
            <small>{{ order.userEmail || 'N/A' }}</small>
            <div class="address">{{ order.deliveryAddress || 'N/A' }}, {{ order.city || 'N/A' }}</div>
          </div>
        </div>
        
        <div class="col-items">
          <div class="items-display">
            <span class="items-text">{{ getItemsText(order.items) }}</span>
            <small>{{ order.items.length }} item(s)</small>
          </div>
        </div>
        
        <div class="col-total">
          <strong>{{ order.total | number:'1.2-2' }} DT</strong>
        </div>
        
        <div class="col-status">
          <span class="status-badge" 
                [ngClass]="getStatusClass(order.status)" 
                [style.background-color]="getStatusColor(order.status)">
            {{ getStatusText(order.status) }}
          </span>
        </div>
        
        <div class="col-time">
          <div class="time-info">
            <span>{{ formatDate(order.createdAt) }}</span>
          </div>
        </div>
        
        <div class="col-actions">
          <!-- Debug ID -->
          <span class="debug-id" style="font-size: 10px; color: #999;">ID: {{ order.id }} ({{ typeof order.id }})</span>
          
          <!-- Bouton Rejeter (seulement pour commandes "en cours") -->
          <button *ngIf="canRejectOrder(order.status)" 
                  (click)="rejectOrder(order.id)" 
                  class="action-btn reject-btn" 
                  title="Rejeter la Commande">
            ‚ùå 
          </button>
          
          <!-- Bouton Marquer comme Livr√©e -->
          <button *ngIf="canMarkAsReady(order.status)" 
                  (click)="markAsReady(order.id)" 
                  class="action-btn ready-btn" 
                  title="Marquer comme Livr√©e">
            üèÅ 
          </button>
          
          <button (click)="viewOrder(order.id)" 
                  class="action-btn view-btn" 
                  title="View Details">
            üîç
          </button>
          <button (click)="printOrder(order.id)" 
                  class="action-btn print-btn" 
                  title="Print Order">
            üñ®Ô∏è
          </button>
        </div>
      </div>
    </div>
    
    <!-- √âtat vide -->
    <div class="empty-state" *ngIf="filteredOrders.length === 0">
      <i class="fas fa-clipboard-list"></i>
      <h3>Aucune commande trouv√©e</h3>
      <p>Aucune commande ne correspond √† vos crit√®res de recherche</p>
    </div>
  </div>
    </div>
  </div>
</div>

<!-- Modal d√©tails commande -->
<div class="modal-overlay" *ngIf="showOrderDetails" (click)="closeOrderDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="selectedOrder">
    <div class="modal-header">
      <h2><i class="fas fa-receipt"></i> Commande #{{ selectedOrder.id }}</h2>
      <button class="close-btn" (click)="closeOrderDetails()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Infos client -->
      <div class="order-section">
        <h3><i class="fas fa-user"></i> Informations Client</h3>
        <div class="customer-details">
          <p><strong>Nom:</strong> {{ selectedOrder.userName || 'N/A' }}</p>
          <p><strong>Email:</strong> {{ selectedOrder.userEmail || 'N/A' }}</p>
          <p><strong>T√©l√©phone:</strong> {{ selectedOrder.userPhone || 'N/A' }}</p>
          <p><strong>Adresse:</strong> {{ selectedOrder.deliveryAddress || 'N/A' }}, {{ selectedOrder.city || 'N/A' }}</p>
        </div>
      </div>
      
      <!-- Articles -->
      <div class="order-section">
        <h3><i class="fas fa-shopping-bag"></i> Articles command√©s</h3>
        <div class="items-display">
          <div *ngFor="let item of selectedOrder.items" class="item-row">
            <span>{{ item.name }} x{{ item.quantity }}</span>
            <span>{{ item.price | number:'1.2-2' }} DT</span>
          </div>
        </div>
        
        <div class="total-section">
          <div class="total-row" *ngIf="selectedOrder.subtotal">
            <div class="total-label">Sous-total:</div>
            <div class="total-amount">{{ selectedOrder.subtotal | number:'1.2-2' }} DT</div>
          </div>
          <div class="total-row" *ngIf="selectedOrder.deliveryFee">
            <div class="total-label">Livraison:</div>
            <div class="total-amount">{{ selectedOrder.deliveryFee | number:'1.2-2' }} DT</div>
          </div>
          <div class="total-row">
            <div class="total-label">Total:</div>
            <div class="total-amount">{{ selectedOrder.total | number:'1.2-2' }} DT</div>
          </div>
        </div>
      </div>

      <!-- Statut et livraison -->
      <div class="order-section">
        <h3><i class="fas fa-truck"></i> Informations de Livraison</h3>
        <div class="delivery-info">
          <div class="status-row">
            <span class="status-label">Statut actuel:</span>
            <span class="status-badge" [ngClass]="'status-' + selectedOrder.status">
              {{ getStatusText(selectedOrder.status) }}
            </span>
          </div>
          <p><strong>Date de commande:</strong> {{ selectedOrder.dateCommande | date:'dd/MM/yyyy HH:mm' }}</p>
          <div *ngIf="selectedOrder.additionalNotes" class="delivery-details">
            <p><strong>Notes:</strong> {{ selectedOrder.additionalNotes }}</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn secondary" (click)="closeOrderDetails()">
        Fermer
      </button>
      <button class="btn primary">
        <i class="fas fa-print"></i>
        Imprimer
      </button>
    </div>
  </div>
</div>