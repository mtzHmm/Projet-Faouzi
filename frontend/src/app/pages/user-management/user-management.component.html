<div class="admin-layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a routerLink="/admin" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon">âš¡</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a routerLink="/admin/orders" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">ğŸ“‹</span>
        <span class="nav-text">Orders</span>
      </a>
      <a routerLink="/user-management" routerLinkActive="active" class="nav-item users-nav">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-text">Users</span>
      </a>
      <a routerLink="/admin/stats" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-text">Stats</span>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Toast Notifications -->
    <div class="toast-container">
      <div *ngIf="showSuccessMessage" class="toast toast-success">
        <div class="toast-icon">âœ…</div>
        <div class="toast-content">
          <div class="toast-title">SuccÃ¨s!</div>
          <div class="toast-message">{{ successMessage }}</div>
        </div>
        <button class="toast-close" (click)="showSuccessMessage = false">Ã—</button>
      </div>
      
      <div *ngIf="showErrorMessage" class="toast toast-error">
        <div class="toast-icon">âŒ</div>
        <div class="toast-content">
          <div class="toast-title">Erreur!</div>
          <div class="toast-message">{{ errorMessage }}</div>
        </div>
        <button class="toast-close" (click)="showErrorMessage = false">Ã—</button>
      </div>
    </div>
    
    <div class="user-management-container">
      <!-- Table Navigation Tabs -->
      <div class="table-tabs">
        <button 
          class="tab-button" 
          [class.active]="activeTable === 'clients'"
          (click)="switchTable('clients')">
          ğŸ‘¤ Clients & Admins ({{ filteredClients.length }})
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTable === 'providers'"
          (click)="switchTable('providers')">
          ğŸª Fournisseurs ({{ filteredProviders.length }})
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTable === 'delivery'"
          (click)="switchTable('delivery')">
          ğŸšš Livreurs ({{ filteredDeliveryUsers.length }})
        </button>
      </div>
      
      <div class="header">
        <h1>Gestion des Utilisateurs</h1>
        <div class="header-actions">
          <button class="btn-refresh" (click)="refreshUsers()" [disabled]="loading" title="Actualiser la liste">
            <span class="refresh-icon">ğŸ”„</span>
            {{ loading ? 'Chargement...' : 'Actualiser' }}
          </button>
        </div>
      </div>

      <div class="filters">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Rechercher utilisateurs..." 
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            class="search-input"
          >
          <span class="search-icon">ğŸ”</span>
        </div>
      </div>

      <!-- Clients Table -->
      <div class="users-table-container" *ngIf="activeTable === 'clients'">
        <h2 class="table-title">ğŸ‘¤ Clients et Administrateurs</h2>
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>PrÃ©nom</th>
              <th>Nom</th>
              <th>Email</th>
              <th>TÃ©lÃ©phone</th>
              <th>RÃ´le</th>
              <th>Gouvernorat</th>
              <th>Ville</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredClients" class="user-row">
              <td>{{ user.id }}</td>
              <td>{{ user.prenom || '-' }}</td>
              <td>{{ user.nom || '-' }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.tel || user.phone || '-' }}</td>
              <td>
                <span class="role-badge" [ngClass]="user.role">
                  {{ user.role === 'admin' ? 'Administrateur' : 'Client' }}
                </span>
              </td>
              <td>{{ user.gouv_client || '-' }}</td>
              <td>{{ user.ville_client || '-' }}</td>
              <td>
                <button class="btn-edit" (click)="editUser(user.id_client || user.id, 'client')" title="Modifier">
                  âœï¸
                </button>
                <button class="btn-delete" (click)="deleteUser(user.id, 'client')" title="Supprimer">
                  ğŸ—‘ï¸
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Providers Table -->
      <div class="users-table-container" *ngIf="activeTable === 'providers'">
        <h2 class="table-title">ğŸª Fournisseurs</h2>
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nom Magasin</th>
              <th>Email</th>
              <th>TÃ©lÃ©phone</th>
              <th>Type</th>
              <th>Gouvernorat</th>
              <th>Ville</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredProviders" class="user-row">
              <td>{{ user.id }}</td>
              <td>{{ user.name || user.fullName || user.nom || '-' }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.tel || user.phone || '-' }}</td>
              <td>{{ user.type || '-' }}</td>
              <td>{{ user.gouv_magasin || '-' }}</td>
              <td>{{ user.ville_magasin || '-' }}</td>
              <td>
                <button class="btn-edit" (click)="editUser(user.id_magazin || user.id, 'magasin')" title="Modifier">
                  âœï¸
                </button>
                <button class="btn-delete" (click)="deleteUser(user.id, 'magasin')" title="Supprimer">
                  ğŸ—‘ï¸
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Delivery Users Table -->
      <div class="users-table-container" *ngIf="activeTable === 'delivery'">
        <h2 class="table-title">ğŸšš Livreurs</h2>
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>PrÃ©nom</th>
              <th>Nom</th>
              <th>Email</th>
              <th>TÃ©lÃ©phone</th>
              <th>VÃ©hicule</th>
              <th>Gouvernorat</th>
              <th>Ville Livraison</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredDeliveryUsers" class="user-row">
              <td>{{ user.id }}</td>
              <td>{{ user.prenom || '-' }}</td>
              <td>{{ user.nom || '-' }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.tel || user.phone || '-' }}</td>
              <td>{{ user.vehicule || '-' }}</td>
              <td>{{ user.gouv_livreur || '-' }}</td>
              <td>{{ user.ville_livraison || '-' }}</td>
              <td>
                <button class="btn-edit" (click)="editUser(user.id_liv || user.id, 'livreur')" title="Modifier">
                  âœï¸
                </button>
                <button class="btn-delete" (click)="deleteUser(user.id, 'livreur')" title="Supprimer">
                  ğŸ—‘ï¸
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="loading-container" *ngIf="loading">
        <div class="loading-spinner">â³</div>
        <p>Chargement des utilisateurs...</p>
      </div>

      <div class="empty-state" *ngIf="!loading && activeTable === 'clients' && filteredClients.length === 0">
        <div class="empty-icon">ğŸ‘¥</div>
        <h3>Aucun client trouvÃ©</h3>
        <p>Il n'y a aucun client dans la base de donnÃ©es.</p>
      </div>

      <div class="empty-state" *ngIf="!loading && activeTable === 'providers' && filteredProviders.length === 0">
        <div class="empty-icon">ğŸª</div>
        <h3>Aucun fournisseur trouvÃ©</h3>
        <p>Il n'y a aucun fournisseur dans la base de donnÃ©es.</p>
      </div>

      <div class="empty-state" *ngIf="!loading && activeTable === 'delivery' && filteredDeliveryUsers.length === 0">
        <div class="empty-icon">ğŸšš</div>
        <h3>Aucun livreur trouvÃ©</h3>
        <p>Il n'y a aucun livreur dans la base de donnÃ©es.</p>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
  <div class="edit-modal wide-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getEditModalTitle() }}</h2>
      <button class="close-btn" (click)="closeEditModal()">âœ•</button>
    </div>
    
    <div class="modal-body" *ngIf="editingUser">
      <form (ngSubmit)="saveUser()" class="edit-form">
        
        <!-- CLIENT/ADMIN TABLE FIELDS -->
        <div *ngIf="editingUser.userType === 'client' || editingUser.userType === 'admin'">
          <div class="form-row">
            <div class="form-group half-width">
              <label for="editNom">Nom de famille *</label>
              <input 
                type="text" 
                id="editNom"
                [(ngModel)]="editingUser.nom"
                name="editNom"
                required
                placeholder="Entrez le nom de famille"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editPrenom">PrÃ©nom *</label>
              <input 
                type="text" 
                id="editPrenom"
                [(ngModel)]="editingUser.prenom"
                name="editPrenom"
                required
                placeholder="Entrez le prÃ©nom"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editEmail">Adresse email *</label>
              <input 
                type="email" 
                id="editEmail"
                [(ngModel)]="editingUser.email"
                name="editEmail"
                required
                placeholder="exemple@email.com"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editTel">NumÃ©ro de tÃ©lÃ©phone</label>
              <input 
                type="number" 
                id="editTel"
                [(ngModel)]="editingUser.tel"
                name="editTel"
                placeholder="NumÃ©ro de tÃ©lÃ©phone"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editRole">RÃ´le utilisateur *</label>
              <select 
                id="editRole"
                [(ngModel)]="editingUser.role"
                name="editRole"
                required
                class="form-select">
                <option value="ADMIN">Administrateur</option>
                <option value="CLIENT">Client</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editGouvClient">Gouvernorat</label>
              <input 
                type="text" 
                id="editGouvClient"
                [(ngModel)]="editingUser.gouv_client"
                name="editGouvClient"
                placeholder="Gouvernorat du client"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editVilleClient">Ville</label>
              <input 
                type="text" 
                id="editVilleClient"
                [(ngModel)]="editingUser.ville_client"
                name="editVilleClient"
                placeholder="Ville du client"
                class="form-input">
            </div>
          </div>
        </div>

        <!-- LIVREUR TABLE FIELDS -->
        <div *ngIf="editingUser.userType === 'delivery'" class="delivery-fields">
          <h3 class="section-title">Informations du livreur</h3>
          
          <div class="form-row">
            <div class="form-group half-width">
              <label for="editNomLiv">Nom de famille *</label>
              <input 
                type="text" 
                id="editNomLiv"
                [(ngModel)]="editingUser.nom"
                name="editNomLiv"
                required
                placeholder="Nom du livreur"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editPrenomLiv">PrÃ©nom *</label>
              <input 
                type="text" 
                id="editPrenomLiv"
                [(ngModel)]="editingUser.prenom"
                name="editPrenomLiv"
                required
                placeholder="PrÃ©nom du livreur"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editEmailLiv">Adresse email *</label>
              <input 
                type="email" 
                id="editEmailLiv"
                [(ngModel)]="editingUser.email"
                name="editEmailLiv"
                required
                placeholder="exemple@email.com"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editTelLiv">NumÃ©ro de tÃ©lÃ©phone</label>
              <input 
                type="number" 
                id="editTelLiv"
                [(ngModel)]="editingUser.tel"
                name="editTelLiv"
                placeholder="NumÃ©ro de tÃ©lÃ©phone"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editVehicule">Type de vÃ©hicule *</label>
              <select 
                id="editVehicule"
                [(ngModel)]="editingUser.vehicule"
                name="editVehicule"
                required
                class="form-select">
                <option value="">SÃ©lectionner un vÃ©hicule</option>
                <option value="voiture">Voiture</option>
                <option value="moto">Moto</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editGouvLivreur">Gouvernorat du livreur</label>
              <input 
                type="text" 
                id="editGouvLivreur"
                [(ngModel)]="editingUser.gouv_livreur"
                name="editGouvLivreur"
                placeholder="Gouvernorat du livreur"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editVilleLivraison">Zone de livraison</label>
              <input 
                type="text" 
                id="editVilleLivraison"
                [(ngModel)]="editingUser.ville_livraison"
                name="editVilleLivraison"
                placeholder="Ville de livraison"
                class="form-input">
            </div>
          </div>
        </div>

        <!-- FOURNISSEUR/MAGASIN TABLE FIELDS -->
        <div *ngIf="editingUser.userType === 'provider'" class="provider-fields">
          <h3 class="section-title">Informations du fournisseur</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="editNomMag">Nom de l'entreprise/magasin *</label>
              <input 
                type="text" 
                id="editNomMag"
                [(ngModel)]="editingUser.nom"
                name="editNomMag"
                required
                placeholder="Nom de l'entreprise ou du magasin"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editEmailMag">Adresse email *</label>
              <input 
                type="email" 
                id="editEmailMag"
                [(ngModel)]="editingUser.email"
                name="editEmailMag"
                required
                placeholder="contact@entreprise.com"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editTelMag">NumÃ©ro de tÃ©lÃ©phone</label>
              <input 
                type="number" 
                id="editTelMag"
                [(ngModel)]="editingUser.tel"
                name="editTelMag"
                placeholder="NumÃ©ro de tÃ©lÃ©phone"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="editType">Type d'activitÃ©</label>
              <input 
                type="text" 
                id="editType"
                [(ngModel)]="editingUser.type"
                name="editType"
                placeholder="Ex: Pharmacie, Restaurant, Boutique, Ã‰picerie..."
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="editGouvMagasin">Gouvernorat</label>
              <input 
                type="text" 
                id="editGouvMagasin"
                [(ngModel)]="editingUser.gouv_magasin"
                name="editGouvMagasin"
                placeholder="Gouvernorat du magasin"
                class="form-input">
            </div>

            <div class="form-group half-width">
              <label for="editVilleMagasin">Ville</label>
              <input 
                type="text" 
                id="editVilleMagasin"
                [(ngModel)]="editingUser.ville_magasin"
                name="editVilleMagasin"
                placeholder="Ville du magasin"
                class="form-input">
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeEditModal()" [disabled]="saving">
            Annuler
          </button>
          <button type="submit" class="save-btn" [disabled]="saving">
            <span *ngIf="!saving">Sauvegarder les modifications</span>
            <span *ngIf="saving">Enregistrement en cours...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>