<div class="admin-layout">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a routerLink="/admin" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon">‚ö°</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a routerLink="/admin/orders" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìã</span>
        <span class="nav-text">Orders</span>
      </a>
      <a routerLink="/user-management" routerLinkActive="active" class="nav-item users-nav">
        <span class="nav-icon">üë•</span>
        <span class="nav-text">Users</span>
      </a>
      <a routerLink="/admin/stats" routerLinkActive="active" class="nav-item">
        <span class="nav-icon">üìä</span>
        <span class="nav-text">Stats</span>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Message de succ√®s -->
    <div *ngIf="showSuccessMessage" class="success-notification">
      <div class="success-content">
        <span class="success-icon">‚úÖ</span>
        <span class="success-text">{{ successMessage }}</span>
        <button class="success-close" (click)="hideSuccessMessage()">√ó</button>
      </div>
    </div>
    
    <div class="user-management-container">
      <div class="header">
        <h1>User Management</h1>
        <div class="header-actions">
          <button class="btn-refresh" (click)="loadUsers()" [disabled]="loading" title="Actualiser la liste">
            <span class="refresh-icon">üîÑ</span>
            {{ loading ? 'Chargement...' : 'Actualiser' }}
          </button>
          <button class="btn-add" (click)="addNewUser()">
            <span class="add-icon">+</span>
            Add New User
          </button>
        </div>
      </div>

      <div class="filters">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Rechercher utilisateurs..." 
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            class="search-input"
          >
          <span class="search-icon">üîç</span>
        </div>
        
        <div class="filter-section">
          <select [(ngModel)]="selectedRole" (ngModelChange)="onRoleFilterChange()" class="role-filter">
            <option value="all">Tous les r√¥les</option>
            <option value="admin">Administrateur</option>
            <option value="client">Client</option>
          </select>
          
          <div class="special-filters">
            <button 
              class="filter-btn provider" 
              [class.active]="selectedRole === 'provider'"
              (click)="selectSpecialRole('provider')"
              title="Afficher les fournisseurs">
              <span class="filter-icon">üè™</span>
              Fournisseurs
            </button>
            <button 
              class="filter-btn delivery" 
              [class.active]="selectedRole === 'delivery'"
              (click)="selectSpecialRole('delivery')"
              title="Afficher les livreurs">
              <span class="filter-icon">üöö</span>
              Livreurs
            </button>
          </div>
        </div>
      </div>

      <div class="role-summary">
        <div class="summary-item">
          <span class="role-count admin">{{ getRoleCount('admin') }}</span>
          <span class="role-label">Admins</span>
        </div>
        <div class="summary-item">
          <span class="role-count client">{{ getRoleCount('client') }}</span>
          <span class="role-label">Clients</span>
        </div>
        <div class="summary-item">
          <span class="role-count provider">{{ getRoleCount('provider') }}</span>
          <span class="role-label">Fournisseurs</span>
        </div>
        <div class="summary-item">
          <span class="role-count delivery">{{ getRoleCount('delivery') }}</span>
          <span class="role-label">Livreurs</span>
        </div>
      </div>

      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nom complet</th>
              <th>Email</th>
              <th>R√¥le</th>
              <th>T√©l√©phone</th>
              <th>Statut</th>
              <th>Total Commandes</th>
              <th>Date d'inscription</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers" class="user-row">
              <td class="user-id">{{ user.id }}</td>
              <td class="user-name">
                <div class="name-info">
                  <strong>{{ user.fullName }}</strong>
                  <div *ngIf="user.storeInfo" class="store-info">
                    <small>{{ user.storeInfo.storeName }} - {{ user.storeInfo.storeType }}</small>
                  </div>
                </div>
              </td>
              <td class="user-email">{{ user.email }}</td>
              <td class="user-role">
                <!-- Affichage diff√©rent selon le type d'utilisateur -->
                <div *ngIf="user.role === 'provider' || user.role === 'delivery'" class="fixed-role">
                  <span class="role-badge" [ngClass]="getRoleClass(user.role)">
                    {{ user.role === 'provider' ? 'Fournisseur' : 'Livreur' }}
                  </span>
                  <small class="role-notice">R√¥le fixe</small>
                </div>
                <div *ngIf="user.role !== 'provider' && user.role !== 'delivery'">
                  <select 
                    [value]="user.role"
                    (change)="onRoleChange(user.id, $event)"
                    class="role-select"
                    [ngClass]="getRoleClass(user.role)"
                    [attr.data-user-id]="user.id"
                    [disabled]="!canChangeRole(user)"
                    [title]="canChangeRole(user) ? 'Changer le r√¥le' : 'Ce r√¥le ne peut pas √™tre modifi√©'">
                    <option value="admin">Administrateur</option>
                    <option value="client">Client</option>
                  </select>
                </div>
              </td>
              <td class="user-phone">{{ user.phone }}</td>
              <td class="user-status">
                <span class="status-badge" [class]="getStatusClass(user.status)">
                  {{ getStatusDisplayName(user.status) }}
                </span>
              </td>
              <td class="user-orders">
                <span class="orders-count">{{ user.totalOrders || 0 }}</span>
              </td>
              <td class="user-date">
                {{ formatDate(user.registrationDate) }}
              </td>
              <td class="user-actions">
                <button class="action-btn edit-btn" 
                        (click)="editUser(user.id)" 
                        [disabled]="editingUserId === user.id"
                        title="Modifier utilisateur">
                  <span class="icon" *ngIf="editingUserId !== user.id">‚úèÔ∏è</span>
                  <span class="icon loading-icon" *ngIf="editingUserId === user.id">‚è≥</span>
                </button>
                <button class="action-btn toggle-btn" (click)="toggleUserStatus(user.id)" 
                        title="{{ user.status === 'active' ? 'Suspendre' : 'Activer' }}">
                  <span class="icon">{{ user.status === 'active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}</span>
                </button>
                <button class="action-btn delete-btn" (click)="deleteUser(user.id)" title="Supprimer utilisateur">
                  <span class="icon">üóëÔ∏è</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <span class="results-count">Affichage de {{ filteredUsers.length }} utilisateur(s)</span>
      </div>
    </div>
  </div>
  
  <!-- Modal d'√©dition -->
  <div *ngIf="showEditModal && editingUser && editingUser.id" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Modifier {{ getEditModalTitle() }}</h3>
        <button class="modal-close" (click)="closeEditModal()">√ó</button>
      </div>
      
      <form class="edit-form" (ngSubmit)="saveUser()" #editForm="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label for="editNom">Nom *</label>
            <input 
              id="editNom" 
              type="text" 
              [(ngModel)]="editingUser.nom" 
              name="nom" 
              required 
              class="form-input"
              maxlength="50">
          </div>
          <div class="form-group" *ngIf="editingUser.userType === 'client' || editingUser.userType === 'livreur'">
            <label for="editPrenom">Pr√©nom *</label>
            <input 
              id="editPrenom" 
              type="text" 
              [(ngModel)]="editingUser.prenom" 
              name="prenom" 
              required 
              class="form-input"
              maxlength="50">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editEmail">Email *</label>
            <input 
              id="editEmail" 
              type="email" 
              [(ngModel)]="editingUser.email" 
              name="email" 
              required 
              class="form-input"
              maxlength="100">
          </div>
          <div class="form-group">
            <label for="editTel">T√©l√©phone</label>
            <input 
              id="editTel" 
              type="tel" 
              [(ngModel)]="editingUser.tel" 
              name="tel" 
              class="form-input">
          </div>
        </div>

        <!-- Champs sp√©cifiques Client -->
        <div *ngIf="editingUser.userType === 'client'" class="client-fields">
          <div class="form-row">
            <div class="form-group">
              <label for="editRole">R√¥le *</label>
              <select 
                id="editRole" 
                [(ngModel)]="editingUser.role" 
                name="role" 
                required 
                class="form-select">
                <option value="CLIENT">Client</option>
                <option value="ADMIN">Administrateur</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editGouv">Gouvernorat</label>
              <input 
                id="editGouv" 
                type="text" 
                [(ngModel)]="editingUser.gouv_client" 
                name="gouv_client" 
                class="form-input"
                maxlength="100">
            </div>
          </div>
          <div class="form-group">
            <label for="editVille">Ville</label>
            <input 
              id="editVille" 
              type="text" 
              [(ngModel)]="editingUser.ville_client" 
              name="ville_client" 
              class="form-input"
              maxlength="100">
          </div>
        </div>

        <!-- Champs sp√©cifiques Livreur -->
        <div *ngIf="editingUser.userType === 'livreur'" class="livreur-fields">
          <div class="form-row">
            <div class="form-group">
              <label for="editVehicule">V√©hicule *</label>
              <select 
                id="editVehicule" 
                [(ngModel)]="editingUser.vehicule" 
                name="vehicule" 
                required 
                class="form-select">
                <option value="voiture">Voiture</option>
                <option value="moto">Moto</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editDisponibilite">Disponibilit√©</label>
              <input 
                id="editDisponibilite" 
                type="time" 
                [(ngModel)]="editingUser.disponibilite" 
                name="disponibilite" 
                class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editVilleLivraison">Ville de livraison</label>
              <input 
                id="editVilleLivraison" 
                type="text" 
                [(ngModel)]="editingUser.ville_livraison" 
                name="ville_livraison" 
                class="form-input"
                maxlength="100">
            </div>
            <div class="form-group">
              <label for="editGouvLivreur">Gouvernorat</label>
              <input 
                id="editGouvLivreur" 
                type="text" 
                [(ngModel)]="editingUser.gouv_livreur" 
                name="gouv_livreur" 
                class="form-input"
                maxlength="100">
            </div>
          </div>
        </div>

        <!-- Champs sp√©cifiques Magasin -->
        <div *ngIf="editingUser.userType === 'magasin'" class="magasin-fields">
          <div class="form-row">
            <div class="form-group">
              <label for="editType">Type de magasin</label>
              <input 
                id="editType" 
                type="text" 
                [(ngModel)]="editingUser.type" 
                name="type" 
                class="form-input"
                maxlength="50">
            </div>
            <div class="form-group">
              <label for="editGouvMagasin">Gouvernorat</label>
              <input 
                id="editGouvMagasin" 
                type="text" 
                [(ngModel)]="editingUser.gouv_magasin" 
                name="gouv_magasin" 
                class="form-input"
                maxlength="100">
            </div>
          </div>
          <div class="form-group">
            <label for="editVilleMagasin">Ville</label>
            <input 
              id="editVilleMagasin" 
              type="text" 
              [(ngModel)]="editingUser.ville_magasin" 
              name="ville_magasin" 
              class="form-input"
              maxlength="100">
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeEditModal()">Annuler</button>
          <button type="submit" class="btn-save" [disabled]="!editForm.valid || saving">
            {{ saving ? 'Sauvegarde...' : 'Sauvegarder' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>